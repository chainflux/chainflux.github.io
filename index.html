<!doctype html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>ChainFlux | Neural Video Engine</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/dexie/dist/dexie.js"></script>

  <style>
    :root {
      --bg: #05070a;
      --fg: #f8fafc;
      --muted: #94a3b8;
      --accent: #4fd1c5;
      --accent-glow: rgba(79, 209, 197, 0.3);
      --border: rgba(255, 255, 255, 0.08);
      --card-bg: rgba(15, 23, 42, 0.6);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg);
      color: var(--fg);
      line-height: 1.6;
      overflow-x: hidden;
    }

    #bg { position: fixed; inset: 0; z-index: 0; pointer-events: none; }
    body > *:not(canvas) { position: relative; z-index: 1; }

    /* 导航栏 */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem 2.5rem;
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(20px);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .logo { 
      font-weight: 600; 
      letter-spacing: 0.1em; 
      color: var(--accent);
      cursor: pointer;
    }
    nav { display: flex; align-items: center; gap: 1.5rem; }
    nav a { 
      color: var(--muted); 
      text-decoration: none; 
      font-size: 0.85rem; 
      cursor: pointer;
      transition: 0.3s;
    }
    nav a:hover { color: var(--accent); }

    /* 页面切换 */
    .page-section { display: none; max-width: 1100px; margin: 6rem auto; padding: 0 2rem; animation: fadeIn 0.5s ease; }
    .page-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* 按钮 */
    .btn {
      display: inline-flex;
      align-items: center;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      border: 1px solid var(--border);
      transition: 0.3s;
      text-decoration: none;
      color: var(--fg);
    }
    .btn.primary {
      background: var(--accent);
      color: #022c22;
      border: none;
      box-shadow: 0 0 20px var(--accent-glow);
    }

    /* 磁贴卡片 */
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-top: 3rem; }
    .card {
      padding: 2rem;
      border: 1px solid var(--border);
      border-radius: 16px;
      background: var(--card-bg);
      backdrop-filter: blur(10px);
    }

    /* AI 生成器 UI */
    .generator-container {
      background: rgba(255,255,255,0.02);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 2.5rem;
    }
    .upload-grid { display: flex; gap: 1.5rem; margin-bottom: 1.5rem; }
    .upload-box {
      flex: 1;
      height: 160px;
      border: 1px dashed var(--border);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    .upload-box img { width: 100%; height: 100%; object-fit: cover; position: absolute; display: none; }
    
    .console-panel {
      background: #000;
      border-radius: 10px;
      padding: 1.25rem;
      font-family: 'Fira Code', monospace;
      font-size: 0.75rem;
      color: #4fd1c5;
      height: 100px;
      overflow-y: auto;
      margin-bottom: 1.5rem;
      border: 1px solid rgba(79, 209, 197, 0.2);
    }

    /* 弹窗认证 (保持上个版本的高级感) */
    #pwdModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, 0.98);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(10px);
    }
    .modal-content {
      background: #0f172a;
      padding: 3rem;
      border-radius: 24px;
      border: 1px solid var(--border);
      text-align: center;
      width: 420px;
    }
    .styled-input {
      width: 100%;
      background: #0b0e14;
      color: white;
      border: 1px solid var(--border);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-family: inherit;
    }

    /* 语言切换显示 */
    [data-lang="en"] .zh { display: none; }
    [data-lang="zh"] .en { display: none; }
  </style>
</head>
<body data-lang="zh">

<canvas id="bg"></canvas>

<div id="pwdModal">
  <div class="modal-content">
    <h2 style="margin:0 0 1rem 0; color: var(--accent);" data-i18n="auth.title">Neural Access</h2>
    <p style="color:var(--muted); font-size: 0.85rem; margin-bottom: 2rem;" data-i18n="auth.desc">请输入授权代码以解锁生成引擎</p>
    <input type="password" id="accessPwd" class="styled-input" placeholder="ACCESS CODE (9991)">
    <input type="text" id="tempApiKey" class="styled-input" placeholder="Ark API Key">
    <button onclick="verifyPassword()" class="btn primary" style="width:100%; justify-content: center;" data-i18n="btn.auth">建立链路</button>
    <p onclick="closeModal()" style="margin-top:20px; font-size:12px; color:var(--muted); cursor:pointer;">取消</p>
  </div>
</div>

<header>
  <div class="logo" onclick="showPage('home')">CHAINFLUX</div>
  <nav>
    <a onclick="showPage('home')" data-i18n="nav.projects">项目</a>
    <a onclick="showPage('home')" data-i18n="nav.about">关于</a>
    <a onclick="tryEnterAI()" style="color:var(--accent); font-weight:600; border:1px solid var(--accent); padding:5px 12px; border-radius:6px;" data-i18n="nav.ai">AI Studio →</a>
    <a onclick="toggleLang()" style="opacity:0.6; font-size:12px;">EN / 中</a>
    <a onclick="resetAll()" style="font-size:10px; opacity:0.3;">RESET</a>
  </nav>
</header>

<main id="home-section" class="page-section active">
  <div style="text-align: center; margin-bottom: 4rem;">
    <h1 style="font-size: 4rem; line-height: 1.1; margin-bottom: 1.5rem; font-weight: 600;">
      <span class="en">Decentralized Intelligence.</span>
      <span class="zh">去中心化智能流。</span>
    </h1>
    <p style="color:var(--muted); font-size:1.2rem; max-width:700px; margin: 0 auto 3rem auto;">
      <span class="en">ChainFlux is a system-oriented workspace for neural video experiments and distributed data pipelines.</span>
      <span class="zh">ChainFlux 是一个面向系统的技术工作区，用于神经视频实验与分布式数据管道探索。</span>
    </p>
    <div style="display: flex; justify-content: center; gap: 1rem;">
      <a class="btn primary" onclick="tryEnterAI()" data-i18n="btn.start">开启推理序列</a>
      <a class="btn" href="https://github.com/chainflux" target="_blank">GitHub</a>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h3 data-i18n="sys.core.title">ChainFlux Core</h3>
      <p data-i18n="sys.core.desc">用于链式数据与状态传播的核心神经抽象层。</p>
    </div>
    <div class="card">
      <h3 data-i18n="sys.flow.title">Motion Engine</h3>
      <p data-i18n="sys.flow.desc">基于事件驱动的响应式视频管道，实现首尾帧完美逻辑补间。</p>
    </div>
    <div class="card">
      <h3 data-i18n="sys.ledger.title">Sync Protocol</h3>
      <p data-i18n="sys.ledger.desc">在分布式节点之间实现确定性任务同步与状态跟踪。</p>
    </div>
  </div>
</main>

<main id="ai-section" class="page-section">
  <h2 style="margin-bottom:2rem; font-size: 2rem;" data-i18n="ai.title">Neural Video Studio</h2>
  
  <div class="generator-container">
    <div class="upload-grid">
      <div class="upload-box" onclick="triggerUpload('firstFrame')">
        <img id="firstFramePreview">
        <span id="firstFrameText" data-i18n="gen.first">载入首帧 (INITIAL)</span>
      </div>
      <div class="upload-box" onclick="triggerUpload('lastFrame')">
        <img id="lastFramePreview">
        <span id="lastFrameText" data-i18n="gen.last">载入尾帧 (TERMINAL)</span>
      </div>
    </div>
    <textarea id="promptInput" style="height: 100px; width:100%;" placeholder="请输入视觉指令描述..."></textarea>
    <div class="console-panel" id="console"><div>> [SYSTEM READY] 等待指令输入...</div></div>
    <div style="display:flex; justify-content: flex-end;">
      <button class="btn primary" id="generateBtn" onclick="handleGenerate()" data-i18n="btn.gen">执行生成序列</button>
    </div>
  </div>

  <div style="margin-top: 4rem;">
    <h3 data-i18n="history.title">归档序列</h3>
    <div id="historyGrid" class="grid" style="margin-top:1rem;"></div>
  </div>
</main>

<input type="file" id="fileInput" style="display:none" accept="image/*">

<script>
/* ===== 国际化配置 ===== */
const i18n = {
  zh: {
    "nav.projects": "项目", "nav.about": "关于", "nav.ai": "AI Studio →",
    "auth.title": "安全协议访问", "auth.desc": "请输入授权代码以解锁生成引擎", "btn.auth": "建立链路",
    "btn.start": "开启推理序列", "sys.core.title": "ChainFlux Core",
    "sys.core.desc": "用于链式数据与状态传播的核心神经抽象层。",
    "sys.flow.title": "运动引擎", "sys.flow.desc": "基于事件驱动的响应式视频管道，实现首尾帧完美逻辑补间。",
    "sys.ledger.title": "同步协议", "sys.ledger.desc": "在分布式节点之间实现确定性任务同步与状态跟踪。",
    "ai.title": "神经视频工作室", "gen.first": "载入首帧 (INITIAL)", 
    "gen.last": "载入尾帧 (TERMINAL)", "btn.gen": "执行生成序列", "history.title": "归档序列"
  },
  en: {
    "nav.projects": "Projects", "nav.about": "About", "nav.ai": "AI Studio →",
    "auth.title": "Neural Access", "auth.desc": "Enter code to unlock engine", "btn.auth": "Establish Link",
    "btn.start": "Start Inference", "sys.core.title": "ChainFlux Core",
    "sys.core.desc": "Neural abstraction layer for state propagation.",
    "sys.flow.title": "Motion Engine", "sys.flow.desc": "Reactive pipelines for perfect interpolation between frames.",
    "sys.ledger.title": "Sync Protocol", "sys.ledger.desc": "Deterministic task synchronization across nodes.",
    "ai.title": "Neural Video Studio", "gen.first": "LOAD INITIAL FRAME", 
    "gen.last": "LOAD TERMINAL FRAME", "btn.gen": "EXECUTE SEQUENCE", "history.title": "Neural Archives"
  }
};

let currentLang = localStorage.getItem('lang') || 'zh';

function toggleLang() {
  currentLang = currentLang === 'zh' ? 'en' : 'zh';
  localStorage.setItem('lang', currentLang);
  applyLang();
}

function applyLang() {
  document.body.setAttribute('data-lang', currentLang);
  document.querySelectorAll('[data-i18n]').forEach(el => {
    el.textContent = i18n[currentLang][el.dataset.i18n];
  });
}

/* ===== 系统逻辑 ===== */
const db = new Dexie("ChainFluxDB");
db.version(1).stores({ history: '++id, prompt, timestamp' });

window.onload = () => {
  applyLang();
  if (localStorage.getItem('verified') === 'true') {
    showPage('ai');
    renderHistory();
  }
};

function showPage(id) {
  document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
  document.getElementById(id + '-section').classList.add('active');
}

function tryEnterAI() {
  if (localStorage.getItem('verified') === 'true') {
    showPage('ai');
    renderHistory();
  } else {
    document.getElementById('pwdModal').style.display = 'flex';
  }
}

function verifyPassword() {
  const pwd = document.getElementById('accessPwd').value;
  const key = document.getElementById('tempApiKey').value;
  if (pwd === "9991") {
    localStorage.setItem('verified', 'true');
    if (key) localStorage.setItem('ark_api_key', key);
    document.getElementById('pwdModal').style.display = 'none';
    showPage('ai');
    renderHistory();
  } else { alert("ACCESS DENIED"); }
}

function closeModal() { document.getElementById('pwdModal').style.display = 'none'; }
function resetAll() { localStorage.clear(); location.reload(); }

function log(msg, isError = false) {
  const div = document.createElement('div');
  if (isError) div.style.color = "#ff5555";
  div.innerText = `> ${msg}`;
  const con = document.getElementById('console');
  con.appendChild(div);
  con.scrollTop = con.scrollHeight;
}

let frames = { firstFrame: null, lastFrame: null };
function triggerUpload(type) {
  const input = document.getElementById('fileInput');
  input.onchange = e => {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = ev => {
      frames[type] = ev.target.result;
      document.getElementById(type + 'Preview').src = ev.target.result;
      document.getElementById(type + 'Preview').style.display = 'block';
      document.getElementById(type + 'Text').style.display = 'none';
      log(`资产已就绪: ${type.toUpperCase()}`);
    };
    reader.readAsDataURL(file);
  };
  input.click();
}

async function handleGenerate() {
  const key = localStorage.getItem('ark_api_key');
  if (!key) return alert("API KEY REQUIRED");
  const btn = document.getElementById('generateBtn');
  btn.disabled = true;
  log("渲染序列初始化...");
  try {
    const response = await fetch('https://ark.cn-beijing.volces.com/api/v3/chat/completions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
      body: JSON.stringify({
        model: "doubao-seed-1-5-pro-250115",
        messages: [{
          role: "user",
          content: [
            { type: "image_url", image_url: { url: frames.firstFrame } },
            ...(frames.lastFrame ? [{ type: "image_url", image_url: { url: frames.lastFrame } }] : []),
            { type: "text", text: document.getElementById('promptInput').value || "Generate Sequence" }
          ]
        }]
      })
    });
    log("正在从云端拉取生成流...");
    const result = await response.json();
    const videoUrl = JSON.stringify(result).match(/https?:\/\/[^\s"]+\.mp4/g);
    if (videoUrl) {
      log("检测到输出流，正在缓存...");
      const blob = await fetch(videoUrl[0]).then(r => r.blob());
      await db.history.add({
        prompt: document.getElementById('promptInput').value || "AI视频",
        videoBlob: blob,
        timestamp: new Date().toLocaleString()
      });
      renderHistory();
      log("同步成功。");
    } else { log("错误：API 未返回有效视频", true); }
  } catch (err) { log("通信中断: " + err.message, true); }
  finally { btn.disabled = false; }
}

async function renderHistory() {
  const items = await db.history.orderBy('id').reverse().toArray();
  const grid = document.getElementById('historyGrid');
  grid.innerHTML = items.map(item => `
    <div class="card" style="padding:10px; border-radius:12px; overflow:hidden;">
      <video src="${URL.createObjectURL(item.videoBlob)}" controls style="width:100%; border-radius:8px;"></video>
      <p style="font-size:12px; margin-top:10px;">${item.prompt}</p>
    </div>
  `).join('');
}

/* 背景粒子动画 */
const canvas = document.getElementById("bg");
const ctx = canvas.getContext("2d");
function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener("resize", resize); resize();
class Star {
  constructor() { this.reset(true); }
  reset(initial = false) {
    this.z = Math.random();
    this.x = initial ? Math.random() * canvas.width : -50;
    this.y = Math.random() * canvas.height;
    this.speed = 0.2 + (1 - this.z) * 1.5;
    this.radius = 0.5 + (1 - this.z) * 1.5;
    this.alpha = 0.15 + (1 - this.z) * 0.4;
  }
  update() { this.x += this.speed; if (this.x > canvas.width + 50) this.reset(); }
  draw() {
    ctx.beginPath();
    ctx.fillStyle = `rgba(79, 209, 197, ${this.alpha})`;
    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
    ctx.fill();
  }
}
const stars = Array.from({length: 150}, () => new Star());
function animate() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  stars.forEach(s => { s.update(); s.draw(); });
  requestAnimationFrame(animate);
}
animate();
</script>
</body>
</html>
