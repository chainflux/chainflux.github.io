<!doctype html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>ChainFlux | AI Studio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/dexie/dist/dexie.js"></script>

  <style>
    :root {
      --bg: #0b0e14; --fg: #e6e8ee; --muted: #8a8f98; --accent: #4fd1c5; --border: #1f2430; --card-bg: #161b22;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Inter, system-ui, sans-serif; background: var(--bg); color: var(--fg); line-height: 1.6; }
    #bg { position: fixed; inset: 0; z-index: 0; pointer-events: none; }
    body > *:not(canvas) { position: relative; z-index: 1; }

    header { display: flex; justify-content: space-between; align-items: center; padding: 24px 40px; border-bottom: 1px solid var(--border); backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 100; }
    .logo { font-weight: 600; letter-spacing: 0.04em; color: var(--accent); cursor: pointer; }
    nav a { margin-left: 24px; color: var(--muted); text-decoration: none; font-size: 14px; cursor: pointer; transition: 0.3s; }
    nav a:hover { color: var(--accent); }

    .page-section { display: none; max-width: 1000px; margin: 40px auto; padding: 0 40px; animation: fadeIn 0.4s ease; }
    .page-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* ç”Ÿæˆå™¨å¡ç‰‡ */
    .generator-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 30px; }
    .upload-container { display: flex; gap: 15px; margin-bottom: 20px; }
    .upload-box { flex: 1; height: 140px; border: 2px dashed #333; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; position: relative; overflow: hidden; }
    .upload-box img { width: 100%; height: 100%; object-fit: cover; position: absolute; }
    
    .chat-console { background: #0b0e14; border: 1px solid var(--border); border-radius: 8px; padding: 15px; font-family: monospace; font-size: 13px; color: #4fd1c5; height: 120px; overflow-y: auto; margin-bottom: 20px; }
    .chat-console div::before { content: "> "; color: var(--muted); }

    textarea, .styled-input { width: 100%; background: #0b0e14; color: white; border: 1px solid var(--border); padding: 12px; border-radius: 8px; font-family: inherit; margin-bottom: 15px; }
    .btn { padding: 12px 24px; border-radius: 6px; font-size: 14px; cursor: pointer; border: 1px solid var(--border); transition: 0.2s; color: var(--fg); background: transparent; }
    .btn.primary { background: var(--accent); color: #081313; border: none; font-weight: 600; }

    /* å†å²è®°å½• */
    .history-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
    .history-item { background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; padding: 10px; }
    video { width: 100%; border-radius: 4px; }

    /* è®¤è¯å¼¹çª— */
    #pwdModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; align-items: center; justify-content: center; }
    .modal-content { background: var(--card-bg); padding: 40px; border-radius: 12px; border: 1px solid var(--border); text-align: center; width: 400px; }
  </style>
</head>
<body>

<canvas id="bg"></canvas>

<div id="pwdModal">
  <div class="modal-content">
    <h3 style="margin:0 0 20px 0; color: var(--accent);">ç³»ç»Ÿç»ˆç«¯è®¿é—®</h3>
    
    <div style="text-align: left; margin-bottom: 15px;">
        <label style="font-size: 12px; color: var(--muted);">è®¿é—®å¯†ç  (å¿…å¡«)</label>
        <input type="password" id="accessPwd" class="styled-input" placeholder="è¾“å…¥ 9991" style="margin-top:5px;">
    </div>

    <div style="text-align: left; margin-bottom: 20px;">
        <label style="font-size: 12px; color: var(--muted);">Ark API Key (å»ºè®®æ­¤æ—¶å¡«å…¥)</label>
        <input type="text" id="tempApiKey" class="styled-input" placeholder="ç²˜è´´æ‚¨çš„ API Key" style="margin-top:5px;">
    </div>

    <button onclick="verifyPassword()" class="btn primary" style="width:100%;">ç¡®è®¤å¹¶è¿›å…¥ç³»ç»Ÿ</button>
    <p onclick="closeModal()" style="margin-top:20px; font-size:12px; color:var(--muted); cursor:pointer;">è¿”å›é¦–é¡µ</p>
  </div>
</div>

<header>
  <div class="logo" onclick="showPage('home')">CHAINFLUX</div>
  <nav>
    <a onclick="showPage('home')">é¦–é¡µ</a>
    <a onclick="tryEnterAI()" id="nav-ai-btn" style="color:var(--accent); font-weight:600;">AI å·¥ä½œç«™ â†’</a>
    <a onclick="resetAll()" style="font-size:11px; opacity:0.5;">é€€å‡º/æ¸…é™¤ç¼“å­˜</a>
  </nav>
</header>

<main id="home-section" class="page-section active">
  <h1 style="font-size: 48px; margin-bottom: 20px;">ç³»ç»ŸåŒ–çš„æ•°æ®æµã€‚</h1>
  <p style="color:var(--muted); font-size:18px; max-width:600px;">è¿™æ˜¯åˆ†å¸ƒå¼ Seedance å·¥ä½œç«™ã€‚è¯·è¿›å…¥ AI å·¥ä½œç«™å¼€å§‹æ‚¨çš„åˆ›ä½œåºåˆ—ã€‚</p>
  <div style="margin-top:40px;">
    <button class="btn primary" onclick="tryEnterAI()">ç«‹å³æ¥å…¥</button>
  </div>
</main>

<main id="ai-section" class="page-section">
  <div class="generator-card">
    <div class="upload-container">
      <div class="upload-box" onclick="triggerUpload('firstFrame')">
        <img id="firstFramePreview">
        <span id="firstFrameText">ğŸ“· è½½å…¥é¦–å¸§</span>
      </div>
      <div class="upload-box" onclick="triggerUpload('lastFrame')">
        <img id="lastFramePreview">
        <span id="lastFrameText">ğŸ“· è½½å…¥å°¾å¸§</span>
      </div>
    </div>

    <textarea id="promptInput" placeholder="æè¿°è§†é¢‘çš„åŠ¨æ€é€»è¾‘..."></textarea>
    
    <div class="chat-console" id="console">
      <div>ç³»ç»Ÿå°±ç»ªã€‚ç­‰å¾…è¾“å…¥æŒ‡ä»¤...</div>
    </div>

    <div style="display:flex; justify-content: flex-end;">
      <button class="btn primary" id="generateBtn" onclick="handleGenerate()">å‘é€æ¨ç†è¯·æ±‚</button>
    </div>
  </div>

  <h2 style="font-size: 18px; margin-bottom: 20px; color: var(--accent);">ç”Ÿæˆå†å²åºåˆ—</h2>
  <div id="historyGrid" class="history-grid"></div>
</main>

<input type="file" id="fileInput" style="display:none" accept="image/*">

<script>
const db = new Dexie("ChainFluxDB");
db.version(1).stores({ history: '++id, prompt, timestamp' });

// åˆå§‹åŒ–çŠ¶æ€ï¼šåªè¦ä¸ç‚¹é‡ç½®ï¼Œä¸”å·²éªŒè¯è¿‡ï¼Œåˆ·æ–°ä¹Ÿä¸æ¶ˆå¤±
window.onload = () => {
  if (localStorage.getItem('verified') === 'true') {
    showPage('ai');
    renderHistory();
  }
};

function tryEnterAI() {
  if (localStorage.getItem('verified') === 'true') {
    showPage('ai');
    renderHistory();
  } else {
    document.getElementById('pwdModal').style.display = 'flex';
  }
}

function verifyPassword() {
  const pwd = document.getElementById('accessPwd').value;
  const key = document.getElementById('tempApiKey').value;

  if (pwd === "9991") {
    // åªæœ‰ç‚¹å‡»ç¡®å®šæŒ‰é’®ä¸”å¯†ç æ­£ç¡®æ‰ä¿å­˜çŠ¶æ€
    localStorage.setItem('verified', 'true');
    if (key) localStorage.setItem('ark_api_key', key);
    
    document.getElementById('pwdModal').style.display = 'none';
    showPage('ai');
    renderHistory();
    
    // å¦‚æœè¿›å…¥äº†ä½†è¿˜æ˜¯æ²¡ Keyï¼Œå†æç¤ºä¸€æ¬¡
    if (!localStorage.getItem('ark_api_key')) {
        const fallbackKey = prompt("éœ€è¦ Ark API Key æ‰èƒ½ç”Ÿæˆè§†é¢‘ï¼Œè¯·è¾“å…¥ï¼š");
        if (fallbackKey) localStorage.setItem('ark_api_key', fallbackKey);
    }
  } else {
    alert("è®¿é—®æ‹’ç»ï¼šå¯†ç é”™è¯¯");
  }
}

function closeModal() {
    document.getElementById('pwdModal').style.display = 'none';
    showPage('home');
}

function showPage(id) {
  document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
  document.getElementById(id + '-section').classList.add('active');
}

function resetAll() {
  if(confirm("ç¡®å®šè¦é€€å‡ºå¹¶æ¸…é™¤æ‰€æœ‰ API Key åŠæœ¬åœ°éªŒè¯çŠ¶æ€å—ï¼Ÿï¼ˆå†å²è®°å½•å°†ä¿ç•™ï¼‰")) {
    localStorage.removeItem('verified');
    localStorage.removeItem('ark_api_key');
    location.reload();
  }
}

function log(msg, isError = false) {
  const con = document.getElementById('console');
  const div = document.createElement('div');
  if (isError) div.style.color = "#ff5555";
  div.innerText = `${new Date().toLocaleTimeString()} - ${msg}`;
  con.appendChild(div);
  con.scrollTop = con.scrollHeight;
}

let frames = { firstFrame: null, lastFrame: null };
function triggerUpload(type) {
  const input = document.getElementById('fileInput');
  input.onchange = e => {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = ev => {
      frames[type] = ev.target.result;
      document.getElementById(type + 'Preview').src = ev.target.result;
      document.getElementById(type + 'Preview').style.display = 'block';
      document.getElementById(type + 'Text').style.display = 'none';
      log(`èµ„äº§å°±ç»ª: ${type}`);
    };
    reader.readAsDataURL(file);
  };
  input.click();
}

async function handleGenerate() {
  const key = localStorage.getItem('ark_api_key');
  if (!key) return alert("è¯·å…ˆé…ç½® API Key");
  if (!frames.firstFrame) return log("é”™è¯¯ï¼šé¦–å¸§ä¸ºç©º", true);

  const btn = document.getElementById('generateBtn');
  btn.disabled = true;
  log("åºåˆ—åˆå§‹åŒ–...");

  try {
    const response = await fetch('https://ark.cn-beijing.volces.com/api/v3/chat/completions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
      body: JSON.stringify({
        model: "doubao-seed-1-5-pro-250115",
        messages: [{
          role: "user",
          content: [
            { type: "image_url", image_url: { url: frames.firstFrame } },
            ...(frames.lastFrame ? [{ type: "image_url", image_url: { url: frames.lastFrame } }] : []),
            { type: "text", text: document.getElementById('promptInput').value || "Generate" }
          ]
        }]
      })
    });

    log("æ­£åœ¨é€šè¿‡äº‘ç«¯èŠ‚ç‚¹è¿›è¡Œæ¸²æŸ“...");
    const result = await response.json();
    const raw = JSON.stringify(result);
    const videoUrl = raw.match(/https?:\/\/[^\s"]+\.mp4/g);

    if (videoUrl) {
      log("æ£€æµ‹åˆ°è¾“å‡ºæµï¼Œå¼€å§‹æœ¬åœ°åŒ–å­˜å‚¨...");
      const blob = await fetch(videoUrl[0]).then(r => r.blob());
      await db.history.add({
        prompt: document.getElementById('promptInput').value || "æœªå‘½ååºåˆ—",
        videoBlob: blob,
        timestamp: new Date().toLocaleString()
      });
      renderHistory();
      log("åŒæ­¥å®Œæˆã€‚");
    } else {
      log("API æœªè¿”å›æœ‰æ•ˆè§†é¢‘ï¼Œè¯·æ£€æŸ¥é…é¢æˆ–æ¨¡å‹çŠ¶æ€ã€‚", true);
    }
  } catch (err) {
    log("ç½‘ç»œä¸­æ–­: " + err.message, true);
  } finally { btn.disabled = false; }
}

async function renderHistory() {
  const items = await db.history.orderBy('id').reverse().toArray();
  const grid = document.getElementById('historyGrid');
  grid.innerHTML = items.map(item => `
    <div class="history-item">
      <video src="${URL.createObjectURL(item.videoBlob)}" controls></video>
      <div style="font-size:11px; margin-top:8px; color:var(--muted);">${item.timestamp}</div>
      <div style="font-size:12px;">${item.prompt}</div>
    </div>
  `).join('');
}

/* ===== ç²’å­èƒŒæ™¯æ¸²æŸ“ ===== */
const canvas = document.getElementById("bg");
const ctx = canvas.getContext("2d");
function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener("resize", resize); resize();
class Star {
  constructor() { this.reset(true); }
  reset(initial = false) {
    this.z = Math.random();
    this.x = initial ? Math.random() * canvas.width : -50;
    this.y = Math.random() * canvas.height;
    this.speed = 0.2 + (1 - this.z) * 1.5;
    this.radius = 0.5 + (1 - this.z) * 1.5;
    this.alpha = 0.2 + (1 - this.z) * 0.5;
  }
  update() { this.x += this.speed; if (this.x > canvas.width + 50) this.reset(); }
  draw() {
    ctx.beginPath();
    ctx.fillStyle = `rgba(79, 209, 197, ${this.alpha})`;
    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
    ctx.fill();
  }
}
const stars = Array.from({length: 150}, () => new Star());
function animate() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  stars.forEach(s => { s.update(); s.draw(); });
  requestAnimationFrame(animate);
}
animate();
</script>
</body>
</html>
