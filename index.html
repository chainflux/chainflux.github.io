<!doctype html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>ChainFlux | Systems & AI Studio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/dexie/dist/dexie.js"></script>

  <style>
    :root {
      --bg: #0b0e14; --fg: #e6e8ee; --muted: #8a8f98; --accent: #4fd1c5; --border: #1f2430; --card-bg: #161b22;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Inter, system-ui, sans-serif; background: var(--bg); color: var(--fg); line-height: 1.6; }
    #bg { position: fixed; inset: 0; z-index: 0; pointer-events: none; }
    body > *:not(canvas) { position: relative; z-index: 1; }

    /* å¯¼èˆªæ  */
    header { display: flex; justify-content: space-between; align-items: center; padding: 24px 40px; border-bottom: 1px solid var(--border); backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 100; }
    .logo { font-weight: 600; letter-spacing: 0.04em; color: var(--accent); cursor: pointer; }
    nav a { margin-left: 24px; color: var(--muted); text-decoration: none; font-size: 14px; cursor: pointer; transition: 0.3s; }
    nav a:hover { color: var(--accent); }

    /* é¡µé¢å¸ƒå±€ */
    .page-section { display: none; max-width: 1000px; margin: 80px auto; padding: 0 40px; animation: fadeIn 0.4s ease; }
    .page-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* æŒ‰é’®ä¸å¡ç‰‡ */
    .btn { display: inline-block; padding: 12px 24px; border-radius: 6px; font-size: 14px; cursor: pointer; border: 1px solid var(--border); transition: 0.2s; text-decoration: none; color: var(--fg); background: transparent; }
    .btn.primary { background: var(--accent); color: #081313; border: none; font-weight: 600; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 24px; margin-top: 40px; }
    .card { padding: 24px; border: 1px solid var(--border); border-radius: 8px; background: var(--card-bg); }

    /* AI ç”Ÿæˆå™¨ä¸“ç”¨ */
    .generator-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 30px; }
    .upload-container { display: flex; gap: 15px; margin-bottom: 20px; }
    .upload-box { flex: 1; height: 140px; border: 2px dashed #333; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; position: relative; overflow: hidden; }
    .upload-box img { width: 100%; height: 100%; object-fit: cover; position: absolute; }
    .chat-console { background: #0b0e14; border: 1px solid var(--border); border-radius: 8px; padding: 15px; font-family: monospace; font-size: 12px; color: var(--accent); height: 100px; overflow-y: auto; margin-bottom: 20px; }
    textarea, .styled-input { width: 100%; background: #0b0e14; color: white; border: 1px solid var(--border); padding: 12px; border-radius: 8px; margin-bottom: 15px; }

    /* å¼¹çª—è®¤è¯ */
    #pwdModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.96); z-index: 2000; align-items: center; justify-content: center; }
    .modal-content { background: var(--card-bg); padding: 40px; border-radius: 12px; border: 1px solid var(--border); text-align: center; width: 400px; }
  </style>
</head>
<body>

<canvas id="bg"></canvas>

<div id="pwdModal">
  <div class="modal-content">
    <h3 style="margin:0 0 20px 0; color: var(--accent);">å®‰å…¨åè®®è®¿é—®</h3>
    <input type="password" id="accessPwd" class="styled-input" placeholder="è®¿é—®å¯†ç  (9991)">
    <input type="text" id="tempApiKey" class="styled-input" placeholder="ç²˜è´´ Ark API Key">
    <button onclick="verifyPassword()" class="btn primary" style="width:100%;">ç¡®è®¤æ¥å…¥</button>
    <p onclick="closeModal()" style="margin-top:20px; font-size:12px; color:var(--muted); cursor:pointer;">å–æ¶ˆ</p>
  </div>
</div>

<header>
  <div class="logo" onclick="showPage('home')">CHAINFLUX</div>
  <nav>
    <a href="#projects" onclick="showPage('home')">Projects</a>
    <a href="#about" onclick="showPage('home')">About</a>
    <a onclick="tryEnterAI()" style="color:var(--accent); font-weight:600; border:1px solid var(--accent); padding:5px 12px; border-radius:4px;">AI Studio â†’</a>
    <a onclick="resetAll()" style="font-size:10px; opacity:0.4;">Reset</a>
  </nav>
</header>

<main id="home-section" class="page-section active">
  <h1>Decentralized Data Flow.</h1>
  <p style="color:var(--muted); font-size:18px; max-width:640px;">
    ChainFlux æ˜¯ä¸€ä¸ªé¢å‘ç³»ç»Ÿçš„æŠ€æœ¯å·¥ä½œåŒºï¼Œç”¨äºæ¢ç´¢åˆ†å¸ƒå¼æ•°æ®ç®¡é“ã€çŠ¶æ€æµè½¬ä¸åŸºç¡€è®¾æ–½è®¾è®¡ã€‚
  </p>
  
  <div style="margin-top: 48px;">
    <a class="btn primary" onclick="tryEnterAI()">Explore AI Systems</a>
    <a class="btn" href="https://github.com/chainflux" target="_blank" style="margin-left:16px;">GitHub</a>
  </div>

  <section id="projects" style="margin-top:100px;">
    <h2 style="font-size: 20px; margin-bottom: 32px;">Systems</h2>
    <div class="grid">
      <div class="card">
        <h3>ChainFlux Core</h3>
        <p style="color:var(--muted); font-size:14px;">ç”¨äºé“¾å¼æ•°æ®ä¸çŠ¶æ€ä¼ æ’­çš„æ ¸å¿ƒæŠ½è±¡å±‚ã€‚</p>
      </div>
      <div class="card">
        <h3>Flow Engine</h3>
        <p style="color:var(--muted); font-size:14px;">ç”¨äºäº‹ä»¶é©±åŠ¨ä¸å“åº”å¼ç³»ç»Ÿçš„å¯ç»„åˆæ•°æ®ç®¡é“ã€‚</p>
      </div>
      <div class="card">
        <h3>Ledger Sync</h3>
        <p style="color:var(--muted); font-size:14px;">åœ¨åˆ†å¸ƒå¼èŠ‚ç‚¹ä¹‹é—´å®ç°ç¡®å®šæ€§åŒæ­¥ã€‚</p>
      </div>
    </div>
  </section>

  <section id="about" style="margin-top:100px;">
    <h2 style="font-size: 20px; margin-bottom: 24px;">About</h2>
    <p style="color:var(--muted); max-width:640px;">
      è¿™æ˜¯ä¸€ä¸ªé•¿æœŸçš„æŠ€æœ¯å®éªŒåœºï¼Œä¸åšè¥é”€ï¼Œä¸è®²æ•…äº‹ï¼Œåªå…³æ³¨ç³»ç»Ÿæœ¬èº«ã€‚
    </p>
  </section>
</main>

<main id="ai-section" class="page-section">
  <h2 style="margin-bottom:10px;">Seedance Studio</h2>
  <div class="generator-card">
    <div class="upload-container">
      <div class="upload-box" onclick="triggerUpload('firstFrame')">
        <img id="firstFramePreview">
        <span id="firstFrameText">ğŸ“· è½½å…¥é¦–å¸§</span>
      </div>
      <div class="upload-box" onclick="triggerUpload('lastFrame')">
        <img id="lastFramePreview">
        <span id="lastFrameText">ğŸ“· è½½å…¥å°¾å¸§</span>
      </div>
    </div>
    <textarea id="promptInput" placeholder="æè¿°è§†é¢‘çš„åŠ¨æ€é€»è¾‘..."></textarea>
    <div class="chat-console" id="console"><div>ç³»ç»Ÿå°±ç»ªã€‚ç­‰å¾…æŒ‡ä»¤...</div></div>
    <div style="display:flex; justify-content: flex-end;">
      <button class="btn primary" id="generateBtn" onclick="handleGenerate()">å‘é€æ¨ç†è¯·æ±‚</button>
    </div>
  </div>
  <h3 style="font-size: 16px; margin-bottom: 20px;">å†å²åºåˆ—</h3>
  <div id="historyGrid" class="grid" style="margin-top:0;"></div>
</main>

<input type="file" id="fileInput" style="display:none" accept="image/*">

<script>
const db = new Dexie("ChainFluxDB");
db.version(1).stores({ history: '++id, prompt, timestamp' });

window.onload = () => {
  if (localStorage.getItem('verified') === 'true') {
    showPage('ai');
    renderHistory();
  }
};

function showPage(id) {
  document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
  document.getElementById(id + '-section').classList.add('active');
}

function tryEnterAI() {
  if (localStorage.getItem('verified') === 'true') {
    showPage('ai');
    renderHistory();
  } else {
    document.getElementById('pwdModal').style.display = 'flex';
  }
}

function verifyPassword() {
  const pwd = document.getElementById('accessPwd').value;
  const key = document.getElementById('tempApiKey').value;
  if (pwd === "9991") {
    localStorage.setItem('verified', 'true');
    if (key) localStorage.setItem('ark_api_key', key);
    document.getElementById('pwdModal').style.display = 'none';
    showPage('ai');
    renderHistory();
  } else { alert("å¯†ç é”™è¯¯"); }
}

function closeModal() { document.getElementById('pwdModal').style.display = 'none'; }

function resetAll() {
  localStorage.removeItem('verified');
  localStorage.removeItem('ark_api_key');
  location.reload();
}

function log(msg, isError = false) {
  const div = document.createElement('div');
  if (isError) div.style.color = "#ff5555";
  div.innerText = `> ${msg}`;
  const con = document.getElementById('console');
  con.appendChild(div);
  con.scrollTop = con.scrollHeight;
}

let frames = { firstFrame: null, lastFrame: null };
function triggerUpload(type) {
  const input = document.getElementById('fileInput');
  input.onchange = e => {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = ev => {
      frames[type] = ev.target.result;
      document.getElementById(type + 'Preview').src = ev.target.result;
      document.getElementById(type + 'Preview').style.display = 'block';
      document.getElementById(type + 'Text').style.display = 'none';
      log(`èµ„äº§å·²è£…è½½: ${type}`);
    };
    reader.readAsDataURL(file);
  };
  input.click();
}

async function handleGenerate() {
  const key = localStorage.getItem('ark_api_key');
  if (!key) return alert("è¯·è®¾ç½® API Key");
  const btn = document.getElementById('generateBtn');
  btn.disabled = true;
  log("åºåˆ—åˆå§‹åŒ–...");
  try {
    const response = await fetch('https://ark.cn-beijing.volces.com/api/v3/chat/completions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
      body: JSON.stringify({
        model: "doubao-seed-1-5-pro-250115",
        messages: [{
          role: "user",
          content: [
            { type: "image_url", image_url: { url: frames.firstFrame } },
            ...(frames.lastFrame ? [{ type: "image_url", image_url: { url: frames.lastFrame } }] : []),
            { type: "text", text: document.getElementById('promptInput').value || "Generate" }
          ]
        }]
      })
    });
    const result = await response.json();
    const videoUrl = JSON.stringify(result).match(/https?:\/\/[^\s"]+\.mp4/g);
    if (videoUrl) {
      log("æ£€æµ‹åˆ°è¾“å‡ºæµï¼ŒåŒæ­¥è‡³ IndexedDB...");
      const blob = await fetch(videoUrl[0]).then(r => r.blob());
      await db.history.add({
        prompt: document.getElementById('promptInput').value || "AIè§†é¢‘",
        videoBlob: blob,
        timestamp: new Date().toLocaleString()
      });
      renderHistory();
      log("æ¸²æŸ“ä»»åŠ¡æˆåŠŸç»“æŸã€‚");
    } else { log("API æœªè¿”å›è§†é¢‘é“¾æ¥", true); }
  } catch (err) { log("é€šä¿¡æ•…éšœ: " + err.message, true); }
  finally { btn.disabled = false; }
}

async function renderHistory() {
  const items = await db.history.orderBy('id').reverse().toArray();
  const grid = document.getElementById('historyGrid');
  grid.innerHTML = items.map(item => `
    <div class="card" style="padding:10px;">
      <video src="${URL.createObjectURL(item.videoBlob)}" controls style="width:100%; border-radius:4px;"></video>
      <p style="font-size:12px; margin:8px 0 0 0;">${item.prompt}</p>
    </div>
  `).join('');
}

/* èƒŒæ™¯ç²’å­åŠ¨ç”» */
const canvas = document.getElementById("bg");
const ctx = canvas.getContext("2d");
function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener("resize", resize); resize();
class Star {
  constructor() { this.reset(true); }
  reset(initial = false) {
    this.z = Math.random();
    this.x = initial ? Math.random() * canvas.width : -50;
    this.y = Math.random() * canvas.height;
    this.speed = 0.2 + (1 - this.z) * 1.5;
    this.radius = 0.5 + (1 - this.z) * 1.5;
    this.alpha = 0.2 + (1 - this.z) * 0.5;
  }
  update() { this.x += this.speed; if (this.x > canvas.width + 50) this.reset(); }
  draw() {
    ctx.beginPath();
    ctx.fillStyle = `rgba(79, 209, 197, ${this.alpha})`;
    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
    ctx.fill();
  }
}
const stars = Array.from({length: 150}, () => new Star());
function animate() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  stars.forEach(s => { s.update(); s.draw(); });
  requestAnimationFrame(animate);
}
animate();
</script>
</body>
</html>
