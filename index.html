<!doctype html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>ChainFlux | Neural Video Engine</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/dexie/dist/dexie.js"></script>

  <style>
    :root {
      --bg: #05070a;
      --fg: #f8fafc;
      --muted: #64748b;
      --accent: #4fd1c5;
      --accent-hover: #38b2ac;
      --border: rgba(255, 255, 255, 0.08);
      --card-bg: #0f172a;
      --input-bg: #1e293b;
    }

    * { box-sizing: border-box; outline: none; }
    body {
      margin: 0;
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg);
      color: var(--fg);
      line-height: 1.6;
      overflow-x: hidden;
    }

    #bg { position: fixed; inset: 0; z-index: 0; pointer-events: none; }
    body > *:not(canvas) { position: relative; z-index: 1; }

    /* 导航栏 */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.25rem 2rem;
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(20px);
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(5, 7, 10, 0.8);
    }
    .logo { 
      font-weight: 700; 
      letter-spacing: 0.05em; 
      background: linear-gradient(90deg, #fff, #94a3b8);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      cursor: pointer;
    }
    nav { display: flex; align-items: center; gap: 1.5rem; }
    nav a { 
      color: var(--muted); 
      text-decoration: none; 
      font-size: 0.85rem; 
      font-weight: 500;
      cursor: pointer;
      transition: 0.2s;
    }
    nav a:hover { color: #fff; }

    /* 页面容器 */
    .page-section { display: none; max-width: 1200px; margin: 0 auto; padding: 4rem 2rem; animation: fadeIn 0.4s ease; }
    .page-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* 通用按钮 */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      border: 1px solid var(--border);
      transition: 0.2s;
      text-decoration: none;
      color: var(--fg);
      background: rgba(255,255,255,0.05);
    }
    .btn:hover { background: rgba(255,255,255,0.1); }
    .btn.primary {
      background: var(--accent);
      color: #0f172a;
      border: none;
    }
    .btn.primary:hover { background: var(--accent-hover); }

    /* 首页磁贴 */
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-top: 3rem; }
    .card {
      padding: 2rem;
      border: 1px solid var(--border);
      border-radius: 16px;
      background: var(--card-bg);
      transition: transform 0.2s;
    }
    .card:hover { border-color: var(--accent); }

    /* =========================================
       新版 AI 工作站 UI (仿 Doubao Dark)
       ========================================= */
    .studio-container {
      max-width: 1000px;
      margin: 0 auto;
    }

    .studio-header {
      margin-bottom: 2rem;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
    }

    /* 核心输入栏容器 */
    .input-bar-wrapper {
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      box-shadow: 0 8px 30px rgba(0,0,0,0.3);
      transition: border-color 0.3s;
    }
    .input-bar-wrapper:focus-within {
      border-color: var(--accent);
    }

    /* 上半部分：控制台/状态 */
    .console-display {
      font-family: 'Fira Code', monospace;
      font-size: 0.75rem;
      color: var(--accent);
      opacity: 0.8;
      min-height: 20px;
      padding-left: 0.5rem;
      border-left: 2px solid var(--accent);
      margin-bottom: 0.5rem;
    }

    /* 下半部分：输入区域 (Flex布局) */
    .input-row {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    /* 首尾帧小方块组 */
    .frame-group {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      background: rgba(0,0,0,0.2);
      padding: 0.5rem;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.05);
    }

    .mini-upload {
      width: 64px;
      height: 64px;
      border: 1px dashed #475569;
      border-radius: 8px;
      cursor: pointer;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: 0.2s;
      background: #0f172a;
      overflow: hidden;
    }
    .mini-upload:hover { border-color: var(--accent); background: #1e293b; }
    .mini-upload span { font-size: 10px; color: var(--muted); margin-top: 4px; }
    .mini-upload i { font-style: normal; font-size: 18px; color: var(--muted); line-height: 1; }
    .mini-upload img { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; display: none; }
    
    .frame-divider { color: var(--muted); font-size: 12px; opacity: 0.5; }

    /* 文本输入框 */
    .prompt-input {
      flex: 1;
      background: transparent;
      border: none;
      color: white;
      font-size: 1rem;
      font-family: inherit;
      resize: none;
      height: 64px; /* 与小方块等高 */
      padding: 0.5rem;
      line-height: 1.5;
    }
    .prompt-input::placeholder { color: #475569; }

    /* 发送按钮 */
    .send-btn {
      width: 48px;
      height: 48px;
      border-radius: 10px;
      border: none;
      background: var(--accent);
      color: #0f172a;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: 0.2s;
    }
    .send-btn:hover { transform: scale(1.05); background: #2dd4bf; }
    .send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; background: #334155; }
    .send-btn svg { width: 20px; height: 20px; fill: currentColor; }

    /* 历史记录网格 */
    .history-card {
      background: #0f172a;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border);
      position: relative;
    }
    .history-card video { width: 100%; display: block; aspect-ratio: 16/9; background: #000; }
    .history-info { padding: 1rem; }
    .history-prompt { font-size: 0.85rem; color: #cbd5e1; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .history-time { font-size: 0.75rem; color: var(--muted); margin-top: 0.5rem; }

    /* 弹窗认证 */
    #pwdModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .modal-box { background: #0f172a; padding: 2.5rem; border-radius: 20px; border: 1px solid var(--border); width: 400px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
    .modal-input { width: 100%; background: #1e293b; border: 1px solid var(--border); padding: 12px; border-radius: 8px; color: white; margin-bottom: 1rem; text-align: center; }
    
    /* 语言辅助 */
    [data-lang="en"] .zh { display: none; }
    [data-lang="zh"] .en { display: none; }
  </style>
</head>
<body data-lang="zh">

<canvas id="bg"></canvas>

<div id="pwdModal">
  <div class="modal-box">
    <h3 style="margin-top:0; color:white;">Neural Access</h3>
    <p style="color:var(--muted); font-size:0.9rem; margin-bottom:1.5rem;" data-i18n="auth.desc">请输入授权码以解锁工作站</p>
    <input type="password" id="accessPwd" class="modal-input" placeholder="CODE (9991)">
    <input type="text" id="tempApiKey" class="modal-input" placeholder="Ark API Key (Optional)">
    <button onclick="verifyPassword()" class="btn primary" style="width:100%;" data-i18n="btn.enter">确认进入</button>
  </div>
</div>

<header>
  <div class="logo" onclick="showPage('home')">CHAINFLUX</div>
  <nav>
    <a onclick="showPage('home')" data-i18n="nav.home">首页</a>
    <a onclick="tryEnterAI()" style="color:var(--accent);" data-i18n="nav.ai">AI 工作站</a>
    <a onclick="toggleLang()" style="font-size:12px; padding:4px 8px; background:rgba(255,255,255,0.05); border-radius:4px;">中 / EN</a>
    <a onclick="resetAll()" style="font-size:12px; opacity:0.3;">RESET</a>
  </nav>
</header>

<main id="home-section" class="page-section active">
  <div style="text-align: center; margin-bottom: 5rem;">
    <h1 style="font-size: 3.5rem; font-weight: 700; line-height: 1.2; margin-bottom: 1.5rem; background: linear-gradient(180deg, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
      <span class="en">Decentralized Video Intelligence.</span>
      <span class="zh">去中心化视频智能。</span>
    </h1>
    <p style="color:var(--muted); font-size:1.1rem; max-width:600px; margin: 0 auto 2.5rem auto;">
      <span class="en">A system-oriented workspace for neural video experiments.</span>
      <span class="zh">面向系统的神经视频实验工作区，探索分布式创作边界。</span>
    </p>
    <button class="btn primary" onclick="tryEnterAI()" data-i18n="btn.start">启动控制台</button>
  </div>

  <div class="grid">
    <div class="card">
      <h3 style="color:var(--accent); margin-top:0;">Core Engine</h3>
      <p style="color:var(--muted); font-size:0.9rem;" data-i18n="card.1">核心抽象层，支持高并发流式处理。</p>
    </div>
    <div class="card">
      <h3 style="color:var(--accent); margin-top:0;">Flow Protocol</h3>
      <p style="color:var(--muted); font-size:0.9rem;" data-i18n="card.2">基于事件驱动的响应式视频管道。</p>
    </div>
    <div class="card">
      <h3 style="color:var(--accent); margin-top:0;">Ledger Sync</h3>
      <p style="color:var(--muted); font-size:0.9rem;" data-i18n="card.3">全球节点间的确定性任务同步。</p>
    </div>
  </div>
</main>

<main id="ai-section" class="page-section">
  <div class="studio-container">
    <div class="studio-header">
      <div>
        <h2 style="margin:0; font-size:1.5rem;" data-i18n="ai.title">Neural Studio</h2>
        <p style="margin:0.5rem 0 0 0; color:var(--muted); font-size:0.9rem;">Model: doubao-seed-1.5-pro</p>
      </div>
    </div>

    <div class="input-bar-wrapper">
      <div class="console-display" id="console">
        > SYSTEM_READY
      </div>

      <div class="input-row">
        <div class="frame-group">
          <div class="mini-upload" onclick="triggerUpload('firstFrame')" title="Upload First Frame">
            <img id="firstFramePreview">
            <i>+</i>
            <span data-i18n="lbl.start">首帧</span>
          </div>
          
          <div class="frame-divider">→</div>
          
          <div class="mini-upload" onclick="triggerUpload('lastFrame')" title="Upload Last Frame">
            <img id="lastFramePreview">
            <i>+</i>
            <span data-i18n="lbl.end">尾帧</span>
          </div>
        </div>

        <textarea id="promptInput" class="prompt-input" placeholder="输入画面描述 / Describe the motion..."></textarea>

        <button id="generateBtn" class="send-btn" onclick="handleGenerate()">
          <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
        </button>
      </div>
    </div>

    <div style="margin-top: 4rem;">
      <h3 style="font-size:1rem; color:var(--muted); margin-bottom:1.5rem;" data-i18n="lbl.history">生成历史</h3>
      <div id="historyGrid" class="grid" style="margin-top:0; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));"></div>
    </div>
  </div>
</main>

<input type="file" id="fileInput" style="display:none" accept="image/*">

<script>
/* 国际化字典 */
const i18n = {
  zh: {
    "nav.home": "首页", "nav.ai": "AI 工作站", "auth.desc": "请输入授权码以解锁工作站",
    "btn.enter": "确认进入", "btn.start": "启动控制台",
    "card.1": "核心抽象层，支持高并发流式处理。", "card.2": "基于事件驱动的响应式视频管道。",
    "card.3": "全球节点间的确定性任务同步。", "ai.title": "神经生成工作台",
    "lbl.start": "首帧", "lbl.end": "尾帧", "lbl.history": "生成历史"
  },
  en: {
    "nav.home": "Home", "nav.ai": "AI Studio", "auth.desc": "Enter access code to unlock",
    "btn.enter": "Enter", "btn.start": "Launch Console",
    "card.1": "Core abstraction for high-concurrency streaming.", "card.2": "Event-driven reactive video pipelines.",
    "card.3": "Deterministic task synchronization globally.", "ai.title": "Neural Video Workbench",
    "lbl.start": "Start", "lbl.end": "End", "lbl.history": "History Archive"
  }
};

let currentLang = localStorage.getItem('lang') || 'zh';

function toggleLang() {
  currentLang = currentLang === 'zh' ? 'en' : 'zh';
  localStorage.setItem('lang', currentLang);
  applyLang();
}

function applyLang() {
  document.body.setAttribute('data-lang', currentLang);
  document.querySelectorAll('[data-i18n]').forEach(el => {
    el.innerText = i18n[currentLang][el.dataset.i18n];
  });
}

/* 核心逻辑 */
const db = new Dexie("ChainFluxDB");
db.version(1).stores({ history: '++id, prompt, timestamp' });

window.onload = () => {
  applyLang();
  if (localStorage.getItem('verified') === 'true') {
    showPage('ai');
    renderHistory();
  }
};

function showPage(id) {
  document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
  document.getElementById(id + '-section').classList.add('active');
}

function tryEnterAI() {
  if (localStorage.getItem('verified') === 'true') {
    showPage('ai');
    renderHistory();
  } else {
    document.getElementById('pwdModal').style.display = 'flex';
  }
}

function verifyPassword() {
  const pwd = document.getElementById('accessPwd').value;
  const key = document.getElementById('tempApiKey').value;
  if (pwd === "9991") {
    localStorage.setItem('verified', 'true');
    if (key) localStorage.setItem('ark_api_key', key);
    document.getElementById('pwdModal').style.display = 'none';
    showPage('ai');
    renderHistory();
  } else { alert("Error: Invalid Access Code"); }
}

function closeModal() { document.getElementById('pwdModal').style.display = 'none'; }
function resetAll() { localStorage.clear(); location.reload(); }

function log(msg, isError = false) {
  const con = document.getElementById('console');
  con.innerText = `> ${msg}`;
  con.style.color = isError ? '#f87171' : '#4fd1c5';
}

let frames = { firstFrame: null, lastFrame: null };
function triggerUpload(type) {
  const input = document.getElementById('fileInput');
  input.onchange = e => {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = ev => {
      frames[type] = ev.target.result;
      document.getElementById(type + 'Preview').src = ev.target.result;
      document.getElementById(type + 'Preview').style.display = 'block';
      log(`资产已加载 [${type}]`);
    };
    reader.readAsDataURL(file);
  };
  input.click();
}

async function handleGenerate() {
  const key = localStorage.getItem('ark_api_key');
  if (!key) return alert("Please configure API Key in settings or reset.");
  
  const btn = document.getElementById('generateBtn');
  btn.disabled = true;
  log("INITIALIZING_NEURAL_LINK...");
  
  try {
    const response = await fetch('https://ark.cn-beijing.volces.com/api/v3/chat/completions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
      body: JSON.stringify({
        model: "doubao-seed-1-5-pro-250115",
        messages: [{
          role: "user",
          content: [
            { type: "image_url", image_url: { url: frames.firstFrame } },
            ...(frames.lastFrame ? [{ type: "image_url", image_url: { url: frames.lastFrame } }] : []),
            { type: "text", text: document.getElementById('promptInput').value || "Generate Video" }
          ]
        }]
      })
    });
    
    log("PROCESSING_STREAM...");
    const result = await response.json();
    const videoUrl = JSON.stringify(result).match(/https?:\/\/[^\s"]+\.mp4/g);
    
    if (videoUrl) {
      log("DOWNLOADING_BUFFER...");
      const blob = await fetch(videoUrl[0]).then(r => r.blob());
      await db.history.add({
        prompt: document.getElementById('promptInput').value || "Generated Sequence",
        videoBlob: blob,
        timestamp: new Date().toLocaleString()
      });
      renderHistory();
      log("SEQUENCE_ARCHIVED");
    } else { log("ERROR: NO_VIDEO_STREAM", true); }
  } catch (err) { log("CONNECTION_LOST: " + err.message, true); }
  finally { btn.disabled = false; }
}

async function renderHistory() {
  const items = await db.history.orderBy('id').reverse().toArray();
  const grid = document.getElementById('historyGrid');
  grid.innerHTML = items.map(item => `
    <div class="history-card">
      <video src="${URL.createObjectURL(item.videoBlob)}" controls></video>
      <div class="history-info">
        <p class="history-prompt">${item.prompt}</p>
        <p class="history-time">${item.timestamp}</p>
      </div>
    </div>
  `).join('');
}

/* 粒子背景 (保留原版流畅效果) */
const canvas = document.getElementById("bg");
const ctx = canvas.getContext("2d");
function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener("resize", resize); resize();
class Star {
  constructor() { this.reset(true); }
  reset(initial = false) {
    this.z = Math.random();
    this.x = initial ? Math.random() * canvas.width : -50;
    this.y = Math.random() * canvas.height;
    this.speed = 0.2 + (1 - this.z) * 1.5;
    this.radius = 0.5 + (1 - this.z) * 1.5;
    this.alpha = 0.15 + (1 - this.z) * 0.4;
  }
  update() { this.x += this.speed; if (this.x > canvas.width + 50) this.reset(); }
  draw() {
    ctx.beginPath();
    ctx.fillStyle = `rgba(79, 209, 197, ${this.alpha})`;
    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
    ctx.fill();
  }
}
const stars = Array.from({length: 150}, () => new Star());
function animate() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  stars.forEach(s => { s.update(); s.draw(); });
  requestAnimationFrame(animate);
}
animate();
</script>
</body>
</html>
