<!doctype html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>ChainFlux | Systems & AI Studio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/dexie/dist/dexie.js"></script>

  <style>
    :root {
      --bg: #0b0e14;
      --fg: #e6e8ee;
      --muted: #8a8f98;
      --accent: #4fd1c5;
      --border: #1f2430;
      --card-bg: #161b22;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, system-ui, sans-serif;
      background: var(--bg);
      color: var(--fg);
      line-height: 1.6;
    }

    #bg { position: fixed; inset: 0; z-index: 0; pointer-events: none; }
    body > *:not(canvas) { position: relative; z-index: 1; }

    /* å¯¼èˆªæ  */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px 40px;
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
    }
    .logo { font-weight: 600; letter-spacing: 0.04em; color: var(--accent); cursor: pointer; }
    nav a { margin-left: 24px; color: var(--muted); text-decoration: none; font-size: 14px; cursor: pointer; transition: 0.3s; }
    nav a:hover { color: var(--accent); }
    nav a.active { color: var(--accent); font-weight: 600; }

    /* å®¹å™¨æ§åˆ¶ */
    .page-section { display: none; max-width: 1000px; margin: 80px auto; padding: 0 40px; animation: fadeIn 0.5s ease; }
    .page-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* æŒ‰é’®æ ·å¼ */
    .btn { display: inline-block; padding: 12px 24px; border-radius: 6px; font-size: 14px; cursor: pointer; border: 1px solid var(--border); transition: 0.2s; text-decoration: none; color: var(--fg); background: transparent; }
    .btn.primary { background: var(--accent); color: #081313; border: none; font-weight: 600; }

    /* AI ç”Ÿæˆå™¨æ ·å¼ */
    .generator-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 30px; margin-bottom: 40px; }
    .upload-container { display: flex; gap: 20px; margin-bottom: 20px; }
    .upload-box { flex: 1; height: 160px; border: 2px dashed #333; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; overflow: hidden; }
    .upload-box:hover { border-color: var(--accent); background: #12181f; }
    .upload-box img { width: 100%; height: 100%; object-fit: cover; display: none; }
    textarea { width: 100%; height: 100px; background: #0b0e14; color: white; border: 1px solid var(--border); padding: 15px; border-radius: 8px; resize: none; margin-bottom: 20px; font-family: inherit; }

    /* å†å²è®°å½• */
    .history-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
    .history-item { background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; padding: 10px; }
    video { width: 100%; border-radius: 4px; }

    /* å¯†ç å¼¹çª— */
    #pwdModal {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000;
      align-items: center; justify-content: center;
    }
    .modal-content { background: var(--card-bg); padding: 40px; border-radius: 12px; border: 1px solid var(--border); text-align: center; }
  </style>
</head>
<body>

<canvas id="bg"></canvas>

<div id="pwdModal">
  <div class="modal-content">
    <h3 style="margin-top:0">èº«ä»½éªŒè¯</h3>
    <p style="color:var(--muted); font-size:14px;">è¯·è¾“å…¥ AI Studio è®¿é—®å¯†ç </p>
    <input type="password" id="accessPwd" style="padding:12px; background:#0b0e14; border:1px solid var(--border); color:white; border-radius:6px; margin: 20px 0; width: 100%;">
    <br>
    <button onclick="verifyPassword()" class="btn primary" style="width: 100%;">è¿›å…¥ç³»ç»Ÿ</button>
    <p onclick="closeModal()" style="margin-top:15px; font-size:12px; color:var(--muted); cursor:pointer;">å–æ¶ˆ</p>
  </div>
</div>

<header>
  <div class="logo" onclick="showPage('home')">CHAINFLUX</div>
  <nav>
    <a onclick="showPage('home')" id="nav-home">Home</a>
    <a onclick="tryEnterAI()" id="nav-ai" style="color:var(--accent); border:1px solid var(--accent); padding:5px 12px; border-radius:4px;">AI Studio â†’</a>
    <a onclick="resetKey()" style="font-size:11px;">é‡ç½® Key</a>
  </nav>
</header>

<main id="home-section" class="page-section active">
  <h1 style="font-size: 48px; font-weight: 600; margin-bottom: 16px;">Decentralized Data Flow.</h1>
  <p style="color:var(--muted); font-size:18px; max-width: 640px;">
    ChainFlux æ˜¯ä¸€ä¸ªé¢å‘ç³»ç»Ÿçš„æŠ€æœ¯å·¥ä½œåŒºï¼Œç”¨äºæ¢ç´¢åˆ†å¸ƒå¼æ•°æ®ç®¡é“ã€çŠ¶æ€æµè½¬ä¸åŸºç¡€è®¾æ–½è®¾è®¡ã€‚
  </p>
  <div style="margin-top: 48px;">
    <button class="btn primary" onclick="tryEnterAI()">ç«‹å³ä½“éªŒ AI ç”Ÿæˆ</button>
    <button class="btn" style="margin-left:16px;">GitHub æºç </button>
  </div>
  
  <div style="margin-top: 100px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px;">
    <div style="padding:24px; border:1px solid var(--border); border-radius:8px;">
      <h3>ChainFlux Core</h3>
      <p style="color:var(--muted); font-size:14px;">æ ¸å¿ƒæŠ½è±¡å±‚ï¼Œæ”¯æŒé“¾å¼æ•°æ®ä¸çŠ¶æ€ä¼ æ’­ã€‚</p>
    </div>
    <div style="padding:24px; border:1px solid var(--border); border-radius:8px;">
      <h3>Flow Engine</h3>
      <p style="color:var(--muted); font-size:14px;">äº‹ä»¶é©±åŠ¨çš„å¯ç»„åˆç®¡é“ã€‚</p>
    </div>
    <div style="padding:24px; border:1px solid var(--border); border-radius:8px;">
      <h3>Ledger Sync</h3>
      <p style="color:var(--muted); font-size:14px;">åˆ†å¸ƒå¼èŠ‚ç‚¹é—´çš„ç¡®å®šæ€§åŒæ­¥ã€‚</p>
    </div>
  </div>
</main>

<main id="ai-section" class="page-section">
  <h1 style="font-size: 32px; margin-bottom: 10px;">Seedance Studio</h1>
  <p style="color:var(--muted); margin-bottom: 40px;">åŸºäº Doubao-Seedance 1.5 Pro çš„è§†é¢‘åˆ›ä½œä¸­å¿ƒ</p>

  <div class="generator-card">
    <div class="upload-container">
      <div class="upload-box" onclick="triggerUpload('firstFrame')">
        <img id="firstFramePreview">
        <span id="firstFrameText">ğŸ“· ä¸Šä¼ é¦–å¸§ (å¿…å¡«)</span>
      </div>
      <div class="upload-box" onclick="triggerUpload('lastFrame')">
        <img id="lastFramePreview">
        <span id="lastFrameText">ğŸ“· ä¸Šä¼ å°¾å¸§ (å¯é€‰)</span>
      </div>
    </div>

    <textarea id="promptInput" placeholder="æè¿°ä½ æƒ³è¦çš„ç”»é¢åŠ¨æ€ï¼Œä¾‹å¦‚ï¼š'é•œå¤´å¹³æ»‘æ‹‰è¿‘ï¼Œç«ç„°ç¼“æ…¢ç‡ƒçƒ§'"></textarea>
    
    <div style="display:flex; justify-content: space-between; align-items:center;">
      <div id="statusTag" style="font-size:12px; color:var(--muted);">Ready</div>
      <button class="btn primary" id="generateBtn" onclick="handleGenerate()">ç«‹å³ç”Ÿæˆè§†é¢‘</button>
    </div>
  </div>

  <section>
    <h2 style="font-size: 20px; margin-bottom: 20px;">å†å²è®°å½•</h2>
    <div id="historyGrid" class="history-grid"></div>
  </section>
</main>

<input type="file" id="fileInput" style="display:none" accept="image/*">

<script>
/* ===== è·¯ç”±æ§åˆ¶ ===== */
const AUTH_PASSWORD = "9991";
let isVerified = sessionStorage.getItem('isVerified') === 'true';

function showPage(pageId) {
  document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
  document.getElementById(pageId + '-section').classList.add('active');
}

function tryEnterAI() {
  if (isVerified) {
    showPage('ai');
    renderHistory();
  } else {
    document.getElementById('pwdModal').style.display = 'flex';
  }
}

function verifyPassword() {
  const pwd = document.getElementById('accessPwd').value;
  if (pwd === AUTH_PASSWORD) {
    isVerified = true;
    sessionStorage.setItem('isVerified', 'true');
    closeModal();
    showPage('ai');
    renderHistory();
    if (!localStorage.getItem('ark_api_key')) promptForKey();
  } else {
    alert("å¯†ç é”™è¯¯ï¼");
  }
}

function closeModal() { document.getElementById('pwdModal').style.display = 'none'; }

/* ===== API ä¸ æ•°æ®åº“é€»è¾‘ ===== */
const db = new Dexie("ChainFluxDB");
db.version(1).stores({ history: '++id, prompt, timestamp' });

function promptForKey() {
  const key = prompt("è¯·è¾“å…¥æ‚¨çš„ç«å±±å¼•æ“ API Key:");
  if (key) localStorage.setItem('ark_api_key', key);
}

function resetKey() {
  localStorage.removeItem('ark_api_key');
  sessionStorage.removeItem('isVerified');
  location.reload();
}

let frames = { firstFrame: null, lastFrame: null };
function triggerUpload(type) {
  const input = document.getElementById('fileInput');
  input.onchange = e => {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = ev => {
      frames[type] = ev.target.result;
      document.getElementById(type + 'Preview').src = ev.target.result;
      document.getElementById(type + 'Preview').style.display = 'block';
      document.getElementById(type + 'Text').style.display = 'none';
    };
    reader.readAsDataURL(file);
  };
  input.click();
}

async function handleGenerate() {
  const key = localStorage.getItem('ark_api_key');
  if (!key) return promptForKey();
  if (!frames.firstFrame) return alert("è¯·ä¸Šä¼ é¦–å¸§");

  const btn = document.getElementById('generateBtn');
  const status = document.getElementById('statusTag');
  btn.disabled = true;
  status.innerText = "æ­£åœ¨è¯·æ±‚ API...";

  try {
    const response = await fetch('https://ark.cn-beijing.volces.com/api/v3/chat/completions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
      body: JSON.stringify({
        model: "doubao-seed-1-5-pro-250115",
        messages: [{
          role: "user",
          content: [
            { type: "image_url", image_url: { url: frames.firstFrame } },
            ...(frames.lastFrame ? [{ type: "image_url", image_url: { url: frames.lastFrame } }] : []),
            { type: "text", text: document.getElementById('promptInput').value || "Generate video" }
          ]
        }]
      })
    });

    const result = await response.json();
    const videoUrlMatch = JSON.stringify(result).match(/https?:\/\/[^\s"]+\.mp4/g);

    if (videoUrlMatch) {
      status.innerText = "ä¿å­˜ä¸­...";
      const videoBlob = await fetch(videoUrlMatch[0]).then(r => r.blob());
      await db.history.add({
        prompt: document.getElementById('promptInput').value || "AIè§†é¢‘",
        videoBlob: videoBlob,
        timestamp: new Date().toLocaleString()
      });
      renderHistory();
      status.innerText = "ç”ŸæˆæˆåŠŸï¼";
    } else {
      alert("æœªæ‰¾åˆ°è§†é¢‘é“¾æ¥ï¼Œè¯·æ£€æŸ¥ API å“åº”");
    }
  } catch (err) { alert("å‡ºé”™: " + err.message); } finally { btn.disabled = false; }
}

async function renderHistory() {
  const items = await db.history.orderBy('id').reverse().toArray();
  const grid = document.getElementById('historyGrid');
  grid.innerHTML = items.map(item => `
    <div class="history-item">
      <video src="${URL.createObjectURL(item.videoBlob)}" controls></video>
      <div style="padding:10px 5px; font-size:12px;">
        <p style="margin:0">${item.prompt}</p>
        <span style="color:var(--muted)">${item.timestamp}</span>
      </div>
    </div>
  `).join('');
}

/* ===== èƒŒæ™¯åŠ¨ç”»ä¿æŒä¸å˜ ===== */
const canvas = document.getElementById("bg");
const ctx = canvas.getContext("2d");
function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener("resize", resize); resize();
class Star {
  constructor() { this.reset(true); }
  reset(initial = false) {
    this.z = Math.random();
    this.x = initial ? Math.random() * canvas.width : -50;
    this.y = Math.random() * canvas.height;
    this.speed = 0.15 + (1 - this.z) * 1.2;
    this.radius = 0.3 + (1 - this.z) * 1.2;
    this.alpha = 0.15 + (1 - this.z) * 0.4;
  }
  update() { this.x += this.speed; if (this.x > canvas.width + 50) this.reset(); }
  draw() {
    ctx.beginPath();
    ctx.fillStyle = `rgba(79, 209, 197, ${this.alpha})`;
    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
    ctx.fill();
  }
}
const stars = Array.from({length: 150}, () => new Star());
function animate() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  stars.forEach(s => { s.update(); s.draw(); });
  requestAnimationFrame(animate);
}
animate();
</script>
</body>
</html>
