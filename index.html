<!doctype html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>ChainFlux | Seedance Video Studio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/dexie/dist/dexie.js"></script>

  <style>
    :root {
      --bg: #0b0e14;
      --fg: #e6e8ee;
      --muted: #8a8f98;
      --accent: #4fd1c5;
      --border: #1f2430;
      --card-bg: #161b22;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, system-ui, sans-serif;
      background: var(--bg);
      color: var(--fg);
      line-height: 1.6;
      overflow-x: hidden;
    }

    #bg { position: fixed; inset: 0; z-index: 0; pointer-events: none; }
    body > *:not(canvas) { position: relative; z-index: 1; }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 40px;
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(10px);
    }

    .logo { font-weight: 600; letter-spacing: 0.04em; color: var(--accent); }

    /* è®¤è¯é®ç½© */
    #authOverlay {
      position: fixed;
      inset: 0;
      background: var(--bg);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .auth-card {
      text-align: center;
      padding: 40px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
    }

    /* ç”Ÿæˆå™¨ä¸»ç•Œé¢ */
    main { max-width: 1000px; margin: 60px auto; padding: 0 20px; }
    
    .generator-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 40px;
    }

    .upload-container {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }

    .upload-box {
      flex: 1;
      height: 160px;
      border: 2px dashed #333;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      position: relative;
      transition: all 0.3s;
      background: #0d1117;
    }

    .upload-box:hover { border-color: var(--accent); background: #12181f; }
    .upload-box img { width: 100%; height: 100%; object-fit: cover; border-radius: 6px; display: none; }
    .upload-box span { font-size: 13px; color: var(--muted); margin-top: 8px; }

    textarea {
      width: 100%;
      height: 100px;
      background: #0b0e14;
      color: white;
      border: 1px solid var(--border);
      padding: 15px;
      border-radius: 8px;
      resize: none;
      font-family: inherit;
      margin-bottom: 20px;
    }

    .btn {
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      border: 1px solid var(--border);
      transition: all 0.2s;
      text-decoration: none;
      display: inline-block;
    }

    .btn.primary {
      background: var(--accent);
      color: #081313;
      border: none;
      font-weight: 600;
    }

    .btn.primary:disabled { opacity: 0.5; cursor: not-allowed; }

    /* å†å²è®°å½•ç½‘æ ¼ */
    .history-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .history-item {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      padding: 10px;
    }

    video { width: 100%; border-radius: 4px; background: #000; }
    .history-info { padding: 10px 5px; font-size: 12px; }
    .history-info p { margin: 0; color: var(--fg); }
    .history-info span { color: var(--muted); display: block; margin-top: 5px; }

    input[type="password"], input[type="text"] {
      padding: 12px;
      background: #0b0e14;
      border: 1px solid var(--border);
      color: white;
      border-radius: 6px;
      margin-bottom: 10px;
      width: 260px;
    }
  </style>
</head>

<body>

<canvas id="bg"></canvas>

<div id="authOverlay">
  <div class="auth-card">
    <div class="logo" style="margin-bottom: 20px;">CHAINFLUX ACCESS</div>
    <input type="password" id="accessKey" placeholder="è¾“å…¥è®¿é—®å¯†ç  (9991)">
    <br>
    <button onclick="checkAuth()" class="btn primary">è¿›å…¥ç³»ç»Ÿ</button>
  </div>
</div>

<header>
  <div class="logo">CHAINFLUX / SEEDANCE</div>
  <nav>
    <a style="color:var(--accent)" onclick="resetKey()">é‡ç½® API Key</a>
  </nav>
</header>

<main id="appContainer" style="display:none;">
  <h1 style="font-size: 32px; margin-bottom: 10px;">è§†é¢‘ç”Ÿæˆå·¥ä½œåŒº</h1>
  <p style="color:var(--muted); margin-bottom: 40px;">ä½¿ç”¨ Doubao-Seedance 1.5 Pro æ¨¡å‹é©±åŠ¨çš„ AI åˆ›ä½œä¸­å¿ƒ</p>

  <div class="generator-card">
    <div class="upload-container">
      <div class="upload-box" onclick="triggerUpload('firstFrame')">
        <img id="firstFramePreview">
        <span id="firstFrameText">ğŸ“· ä¸Šä¼ é¦–å¸§ (å¿…é€‰)</span>
      </div>
      <div class="upload-box" onclick="triggerUpload('lastFrame')">
        <img id="lastFramePreview">
        <span id="lastFrameText">ğŸ“· ä¸Šä¼ å°¾å¸§ (å¯é€‰)</span>
      </div>
    </div>

    <textarea id="promptInput" placeholder="è¾“å…¥è§†é¢‘åˆ›æ„æè¿°ï¼Œä¾‹å¦‚ï¼š'é•œå¤´å¹³æ»‘å‘å‰æ¨ï¼Œå…‰å½±æµè½¬...'"></textarea>
    
    <div style="display:flex; justify-content: space-between; align-items:center;">
      <div id="statusTag" style="font-size:12px; color:var(--muted);">Ready</div>
      <button class="btn primary" id="generateBtn" onclick="handleGenerate()">ç«‹å³ç”Ÿæˆè§†é¢‘</button>
    </div>
  </div>

  <section>
    <h2 style="font-size: 20px; margin-bottom: 20px;">å†å²è®°å½• (æœ¬åœ°ç¼“å­˜)</h2>
    <div id="historyGrid" class="history-grid">
      </div>
  </section>
</main>

<input type="file" id="fileInput" style="display:none" accept="image/*">

<script>
/* ===== æ ¸å¿ƒé…ç½® ===== */
const AUTH_PASSWORD = "9991";
let ARK_API_KEY = localStorage.getItem('ark_api_key') || "";

// æ•°æ®åº“åˆå§‹åŒ–
const db = new Dexie("ChainFluxDB");
db.version(1).stores({
  history: '++id, prompt, timestamp' 
});

/* ===== è®¿é—®æ§åˆ¶ ===== */
function checkAuth() {
  const pwd = document.getElementById('accessKey').value;
  if (pwd === AUTH_PASSWORD) {
    document.getElementById('authOverlay').style.display = 'none';
    document.getElementById('appContainer').style.display = 'block';
    if (!ARK_API_KEY) promptForKey();
    renderHistory();
  } else {
    alert("å¯†ç ä¸æ­£ç¡®");
  }
}

function promptForKey() {
  const key = prompt("è¯·è¾“å…¥æ‚¨çš„ç«å±±å¼•æ“ (Ark) API Key:");
  if (key) {
    ARK_API_KEY = key;
    localStorage.setItem('ark_api_key', key);
  }
}

function resetKey() {
  localStorage.removeItem('ark_api_key');
  location.reload();
}

/* ===== å›¾ç‰‡å¤„ç† ===== */
let frames = { firstFrame: null, lastFrame: null };

function triggerUpload(type) {
  const input = document.getElementById('fileInput');
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      frames[type] = ev.target.result;
      document.getElementById(`${type}Preview`).src = ev.target.result;
      document.getElementById(`${type}Preview`).style.display = 'block';
      document.getElementById(`${type}Text`).style.display = 'none';
    };
    reader.readAsDataURL(file);
  };
  input.click();
}

/* ===== API è°ƒç”¨é€»è¾‘ ===== */
async function handleGenerate() {
  if (!ARK_API_KEY) return promptForKey();
  if (!frames.firstFrame) return alert("è¯·è‡³å°‘ä¸Šä¼ é¦–å¸§å›¾ç‰‡");

  const promptText = document.getElementById('promptInput').value;
  const btn = document.getElementById('generateBtn');
  const status = document.getElementById('statusTag');

  btn.disabled = true;
  status.innerText = "æ­£åœ¨è¯·æ±‚ API...";

  // æ„å»ºæ¶ˆæ¯å†…å®¹
  const content = [];
  content.push({ type: "image_url", image_url: { url: frames.firstFrame } });
  if (frames.lastFrame) {
    content.push({ type: "image_url", image_url: { url: frames.lastFrame } });
  }
  content.push({ type: "text", text: promptText || "Generate a cinematic video." });

  try {
    const response = await fetch('https://ark.cn-beijing.volces.com/api/v3/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${ARK_API_KEY}`
      },
      body: JSON.stringify({
        model: "doubao-seed-1-5-pro-250115", // ç¡®è®¤æ‚¨çš„å¯ç”¨æ¨¡å‹ ID
        messages: [{ role: "user", content: content }],
        stream: false 
      })
    });

    const result = await response.json();
    
    // è§£æè§†é¢‘é“¾æ¥ (æ ¹æ® Seedance å®é™… Response è°ƒæ•´)
    // é€šå¸¸ API ä¼šè¿”å›ä¸€æ®µåŒ…å«è§†é¢‘ URL çš„æ–‡æœ¬æˆ– JSON å¯¹è±¡
    const videoUrlMatch = JSON.stringify(result).match(/https?:\/\/[^\s"]+\.mp4/g);

    if (videoUrlMatch) {
      status.innerText = "ä¸‹è½½å¹¶ç¼“å­˜è§†é¢‘ä¸­...";
      const videoBlob = await fetch(videoUrlMatch[0]).then(r => r.blob());
      await db.history.add({
        prompt: promptText || "AIç”Ÿæˆçš„è§†é¢‘",
        videoBlob: videoBlob,
        timestamp: new Date().toLocaleString()
      });
      renderHistory();
      status.innerText = "ç”Ÿæˆå®Œæˆï¼";
    } else {
      console.error("Full Response:", result);
      alert("ç”Ÿæˆç»“æŸï¼Œä½†æœªèƒ½åœ¨è¿”å›å†…å®¹ä¸­è§£æåˆ°è§†é¢‘åœ°å€ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°ã€‚");
    }
  } catch (err) {
    alert("API è°ƒç”¨å¤±è´¥: " + err.message);
  } finally {
    btn.disabled = false;
  }
}

/* ===== æ¸²æŸ“å†å² ===== */
async function renderHistory() {
  const items = await db.history.orderBy('id').reverse().toArray();
  const grid = document.getElementById('historyGrid');
  grid.innerHTML = items.map(item => `
    <div class="history-item">
      <video src="${URL.createObjectURL(item.videoBlob)}" controls></video>
      <div class="history-info">
        <p>${item.prompt}</p>
        <span>${item.timestamp}</span>
        <a href="${URL.createObjectURL(item.videoBlob)}" download="video.mp4" style="color:var(--accent); text-decoration:none; font-size:11px;">ä¸‹è½½åˆ°æœ¬åœ°</a>
      </div>
    </div>
  `).join('');
}

/* ===== èƒŒæ™¯åŠ¨ç”» (ä¿æŒåŸæœ‰é€»è¾‘) ===== */
const canvas = document.getElementById("bg");
const ctx = canvas.getContext("2d");
function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener("resize", resize);
resize();

class Star {
  constructor() { this.reset(true); }
  reset(initial = false) {
    this.z = Math.random();
    this.x = initial ? Math.random() * canvas.width : -50;
    this.y = Math.random() * canvas.height;
    this.speed = 0.15 + (1 - this.z) * 1.2;
    this.radius = 0.3 + (1 - this.z) * 1.2;
    this.alpha = 0.15 + (1 - this.z) * 0.4;
  }
  update() { this.x += this.speed; if (this.x > canvas.width + 50) this.reset(); }
  draw() {
    ctx.beginPath();
    ctx.fillStyle = `rgba(79, 209, 197, ${this.alpha})`;
    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
    ctx.fill();
  }
}
const stars = Array.from({length: 150}, () => new Star());
function animate() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  stars.forEach(s => { s.update(); s.draw(); });
  requestAnimationFrame(animate);
}
animate();
</script>

</body>
</html>
